FROM node:18

ARG ARG_VITE_URL_API
ENV VITE_URL_API=$ARG_VITE_URL_API
ENV REDIRECT_URI=${ARG_VITE_URL_API}:5999/login/return/
ENV BACK=${ARG_VITE_URL_API}:7000/

ARG ARG_FORTYTWO_CLIENT_ID
ENV FORTYTWO_CLIENT_ID=$ARG_FORTYTWO_CLIENT_ID

ARG ARG_FORTYTWO_CLIENT_SECRET
ENV FORTYTWO_CLIENT_SECRET=$ARG_FORTYTWO_CLIENT_SECRET

ARG ARG_JWT_SECRET
ENV JWT_SECRET=$ARG_JWT_SECRET

ARG TWO_FACTOR_AUTHENTICATION_APP_NAME
ENV TWO_FACTOR_AUTHENTICATION_APP_NAME=$ARG_TWO_FACTOR_AUTHENTICATION_APP_NAME

ARG ARG_USER
ENV DB_USER=$ARG_USER

ARG ARG_PASSWORD
ENV DB_PASS=$ARG_PASSWORD

ARG ARG_DBNAME
ENV DB_NAME=$ARG_DBNAME

ENV DB_SCHEMA=postgres
ENV DB_HOST=db
ENV DB_PORT=5432

WORKDIR /usr/src/app

RUN curl -f https://get.pnpm.io/v6.16.js | node - add --global pnpm

ENV PATH="/pnpm:$PATH"
ENV PNPM_HOME="/pnpm"

COPY src/package*.json ./

RUN pnpm install

RUN pnpm i -g @nestjs/cli 
RUN pnpm i multer express @nestjs/platform-express @types/multer

COPY src/. .

RUN pnpm build

EXPOSE 6000 7000 7001 7002 7003 7004

CMD [ "pnpm", "start:prod" ]